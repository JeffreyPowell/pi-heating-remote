<?php 
header('Content-Type: application/xml');

w1dir = "/sys/bus/w1/devices/";

$sensorfile = '/home/pi/pi-heating/config/sensors.ini';

$sensors = parse_ini_file($sensorfile);

// Scan sensors

$output = "<xml>";
$output .= "<root>";

foreach ($sensors as $sensor){
    do {
        $raw_data = file_get_contents(w1dir.$sensor[0].'/w1_slave');
        $success = substr( explode( "\n", $raw_data )[0], -3, 3 );
    } while ( $success !="YES" );

    $value = (float)substr( explode( "\n", $raw_data )[1], -5, 5 ) * 1000.0;

    $output .= "<sensor><id>".$sensor."</id><name>".$name."</name><value>".$value."</value></sensor>";
}

$output .= "</root>";

print ($output);

?> 
